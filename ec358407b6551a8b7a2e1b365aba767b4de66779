---
type: learnings
timestamp: '2025-12-26T20:40:01.710809+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T20:40:01.726856+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T20:40:01.746240+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T20:47:19.330840+00:00'
summary: Process isolation is the root cause of empty metrics
---

Process isolation is the root cause of empty metrics
## Summary
The `/memory:metrics` command shows empty output because each slash command runs in an **isolated Python process**. Metrics collected during one operation die with that process before the next command can see them.

## Architecture Details

### The In-Memory Singleton Problem

```
┌─────────────────────────────────────────────────────────────────────┐
│  /memory:capture "test"                                              │
│  ┌─────────────────┐                                                │
│  │ Python Process A │                                               │
│  │  MetricsCollector (empty → collects metrics → pushes to OTLP)   │
│  └─────────────────┘                                                │
│           ↓ process exits, metrics die                              │
└─────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────┐
│  /memory:metrics                                                     │
│  ┌─────────────────┐                                                │
│  │ Python Process B │  ← COMPLETELY SEPARATE PROCESS                │
│  │  MetricsCollector() ← FRESH, EMPTY                               │
│  └─────────────────┘                                                │
│           ↓ shows nothing because no operations ran in THIS process │
└─────────────────────────────────────────────────────────────────────┘
```

### The Push Model (OTLP)

The code DOES push metrics to OTLP—but only at specific points:

| Location | When | What's Pushed |
|----------|------|---------------|
| `capture.py:812` | After each capture | Capture metrics |
| `stop_handler.py:541` | On session Stop | All session metrics + traces |
| `hook_utils.py:572` | Helper function | Metrics collected so far |

**BUT** this only works if `MEMORY_PLUGIN_OTLP_ENDPOINT` is set DURING those operations.

## Related Files
- src/git_notes_memory/observability/metrics.py:485-502 (singleton pattern)
- src/git_notes_memory/observability/exporters/otlp.py:552-565 (push function)
- src/git_notes_memory/hooks/stop_handler.py:541 (Stop hook export)
