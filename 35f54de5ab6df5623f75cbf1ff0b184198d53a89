---
type: learnings
timestamp: '2025-12-26T20:35:24.612869+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T20:35:24.629020+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T20:35:24.648432+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T20:36:05.368468+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487
