---
type: learnings
timestamp: '2025-12-26T19:34:52.772031+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:34:52.792088+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:34:52.815063+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T19:39:04.338215+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:39:04.358732+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:39:04.378335+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T19:41:39.425190+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:41:39.454352+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:41:39.480811+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T19:45:15.587139+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:45:15.608490+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:45:15.629428+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T19:46:33.827170+00:00'
summary: '▶ learned ─────────────────────────────────────

  Issue #28 validated: Stop hook uses push_notes_to...'
tags:
- auto-captured
- pre-compact
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:46:33.874874+00:00'
summary: '▶ learned ─────────────────────────────────────

  Telemetry export is batched at session end, not d...'
tags:
- auto-captured
- pre-compact
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:46:33.918868+00:00'
summary: '▶ learned ─────────────────────────────────────

  UserPromptSubmit hook runs on USER prompts, not a...'
tags:
- auto-captured
- pre-compact
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T19:46:33.999286+00:00'
summary: '▶ learned ─────────────────────────────────────

  Duplicate labels caused by double resource attrib...'
tags:
- auto-captured
- pre-compact
---

Duplicate labels caused by double resource attribute injection
## Root Cause Analysis
The `service.name` attribute is being added twice:
1. Python's `OTLPExporter._make_resource()` adds it in the OTLP payload
2. Collector's `resource` processor (lines 36-40) adds it again via upsert

When Prometheus exporter converts resource→labels, duplicates occur.

## Fix Options
1. Remove resource processor from metrics pipeline in collector config
2. Add `resource_to_telemetry_conversion: disabled` to prometheus exporter
3. Ensure Python and collector don't both add same attributes

## Related Files
- docker/otel-collector-config.yaml:35-43 (resource processor)
- src/git_notes_memory/observability/exporters/otlp.py:193-206 (_make_resource)

---
type: learnings
timestamp: '2025-12-26T19:51:24.546063+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:51:24.566454+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:51:24.586049+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T19:54:38.563775+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T19:54:38.584208+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T19:54:38.605558+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T20:01:53.371903+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T20:01:53.391755+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T20:01:53.410843+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T20:05:44.387791+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T20:05:44.407210+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T20:05:44.427049+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T20:10:06.059478+00:00'
summary: test content
tags:
- explicit
- testing
---

test content

---
type: learnings
timestamp: '2025-12-26T20:10:42.393626+00:00'
summary: 'Issue #28 validated: Stop hook uses push_notes_to_remote() which causes
  race conditions'
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487

---
type: learnings
timestamp: '2025-12-26T20:10:42.414081+00:00'
summary: Telemetry export is batched at session end, not during session
---

Telemetry export is batched at session end, not during session
## Summary
Metrics, traces, and logs are collected during the session but only exported to OTLP when the Stop hook runs at session termination. This is intentional batch export design.

## Context
- `stop_handler.py:505-597` handles all OTLP exports
- Metrics accumulate in-memory during session
- `export_metrics_if_configured()` called only at session end
- No mid-session push to reduce network overhead

## Related Files
- src/git_notes_memory/hooks/stop_handler.py:505-597

---
type: learnings
timestamp: '2025-12-26T20:10:42.434256+00:00'
summary: UserPromptSubmit hook runs on USER prompts, not assistant output
---

UserPromptSubmit hook runs on USER prompts, not assistant output
## Summary
The signal detector runs on UserPromptSubmit hook which only sees user input. Memory blocks in assistant responses (like mine) are NOT captured by this hook.

## Context
- `user_prompt_handler.py` processes user prompts
- Detection happens in user's input text, not Claude's responses
- Memory blocks I write in responses go uncaptured

## Related Files
- src/git_notes_memory/hooks/user_prompt_handler.py
- src/git_notes_memory/hooks/signal_detector.py:183-190

---
type: learnings
timestamp: '2025-12-26T20:11:07.432452+00:00'
summary: '▶ learned ─────────────────────────────────────

  Issue #28 validated: Stop hook uses push_notes_to...'
tags:
- auto-captured
- pre-compact
---

Issue #28 validated: Stop hook uses push_notes_to_remote() which causes race conditions
## Summary
Multi-worktree notes conflicts occur because stop_handler.py:482 calls `push_notes_to_remote()` directly instead of the proper `sync_notes_with_remote(push=True)` method.

## Code Analysis
- `push_notes_to_remote()` at git_ops.py:1222 pushes without fetching first
- `sync_notes_with_remote()` at git_ops.py:1238 implements correct fetch→merge→push workflow
- Fix is straightforward: replace one method call with another

## Related Files
- src/git_notes_memory/git_ops.py:1222-1281
- src/git_notes_memory/hooks/stop_handler.py:473-487
